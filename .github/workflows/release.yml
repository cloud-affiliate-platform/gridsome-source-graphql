name: Release
'on':
  push:
    branches:
      - master
jobs:
  release:
    name: Release
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: 'Setup Node.js'
        uses: actions/setup-node@v1
        with:
          node-version: 12
      - run: npm install
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          NPM_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
      - run: npm run build:ci
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          NPM_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
      - run: npx semantic-release
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          NPM_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
      
      - uses: docker/login-action@v1 
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.PACKAGE_REGISTRY_TOKEN }}

      - name: Push to GitHub Packages
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: |
            ghcr.io/cloud-affiliate-platform/database/postgraphile:latest
                        
      # - name: send message
      #   uses: olabiniV2/matrix-message@v0.0.1
      #   with:
      #     room_id: ${{ secrets.MATRIX_ROOM_ID }}
      #     access_token: ${{ secrets.MATRIX_TOKEN }}
      #     subject: "new version released: ${GITHUB_REPOSITORY}"
      #     message: "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
      #     server: "oliverlorenz.com"
